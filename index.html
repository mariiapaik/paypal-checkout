<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Оплата курса</title>
  <style>
    :root { --bg:#0b0c10; --card:#15171c; --text:#e9edf1; --muted:#98a2b3; --radius:16px; }
    *{box-sizing:border-box} html,body{height:100%}
    body{
      margin:0; background:radial-gradient(1200px 600px at 80% -10%, #1b1e27 0, #0b0c10 55%);
      color:var(--text); font:16px/1.5 ui-sans-serif,system-ui,-apple-system,Inter,Segoe UI,Roboto,Helvetica,Arial;
      display:grid; place-items:center; padding:24px;
    }
    .card{
      width:min(680px,92vw); background:linear-gradient(180deg,#171a20,#12141a);
      border:1px solid #242735; border-radius:var(--radius);
      box-shadow:0 10px 30px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.02);
      padding:clamp(20px,3.5vw,36px);
    }
    h1{margin:0 0 6px; font-size:clamp(22px,3.2vw,28px)}
    .sub{margin:0 0 18px; color:var(--muted); font-size:14px}
    .price{display:inline-block; margin:10px 0 22px; padding:8px 12px; border:1px dashed #2b3042; border-radius:999px; color:#cbd5e1; font-weight:600}
    .divider{height:1px; background:#222532; margin:18px 0}
    .note{margin-top:18px; color:var(--muted); font-size:12px}
    .footer{margin-top:14px; display:flex; gap:10px; align-items:center; color:var(--muted); font-size:12px}
    .badge{color:#c7d2fe; background:#1d2140; border:1px solid #2a2f6c; padding:4px 8px; border-radius:999px}
    .warn{background:#2a1320;border:1px solid #53233f;color:#ffd0d8;padding:12px 14px;border-radius:12px;margin:12px 0}
    .ok{background:#112618;border:1px solid #1f5c34;color:#c9ffd9;padding:12px 14px;border-radius:12px;margin:12px 0}
    .hidden{display:none}
    a.btn{display:inline-block;padding:10px 14px;border:1px solid #2b3042;border-radius:10px;color:#e9edf1;text-decoration:none}
  </style>

   <script src="https://www.paypal.com/sdk/js?client-id=AaCW_wfVK0JYsbuxBxi9TOvEgIJQWGGW9rhdjETZdEejtDcllJ4DHvhuG-qESssWAk3iSKWH_y_Y_35j&components=buttons&currency=EUR&intent=capture"></script>
</head>
<body>
  <main class="card">
    <h1>Оплата курса</h1>
    <p class="sub">После успешной оплаты доступ к урокам придёт в Telegram-бот.</p>
    <div class="price">€10.00 • единоразово</div>

    <div id="params-missing" class="warn hidden">
      Ваша ссылка не содержит параметров. Откройте страницу оплаты заново из бота — нажмите «Оплатить».
    </div>
    <div id="expired" class="warn hidden">
      Ссылка на оплату истекла. <a id="expired-link" class="btn" href="#">Получить новую ссылку</a>
    </div>
    <div id="ok-msg" class="ok hidden">
      Оплата прошла ✅ Проверьте сообщения в Telegram-боте — там отправлен первый урок.
    </div>

    <div id="paypal"></div>

    <div class="divider"></div>
    <p class="note">
      Поддерживаются PayPal и банковские карты. Если оплата не началась или ссылка истекла — вернитесь в бот и нажмите «Оплатить» ещё раз.
    </p>

    <div class="footer">
      <span class="badge">Безопасный платёж</span><span>Обработка через PayPal</span>
    </div>
  </main>

  <script>
    const API_BASE = 'https://telegram-course-bot-lasico4qya-lm.a.run.app'; 
    const BOT = 'SDDSbecomingherCOURSE_bot'; 

    const $ = (id) => document.getElementById(id);
    const qs = new URLSearchParams(location.search);
    const CTX = {
      uid: Number(qs.get('uid') || '0'),
      ts: Number(qs.get('ts') || '0'),
      state: qs.get('state') || ''
    };

    function show(el, flag=true){ el.classList[flag ? 'remove' : 'add']('hidden'); }
    function hide(el){ show(el, false); }

    function openBotChat() {
      const web = `https://t.me/${BOT}`;
      const deep = `tg://resolve?domain=${BOT}`;

      location.href = deep;
      setTimeout(() => { location.href = web; }, 300);
    }

    function showExpired(newUrl) {
      $('paypal').style.display = 'none';
      $('expired-link').href = newUrl;
      show($('expired'));
    }

    async function createOrderOnBackend() {
      const res = await fetch(`${API_BASE}/paypal/create-order`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
        body: JSON.stringify(CTX),
      });

      if (res.status === 410) {
        const payload = await res.json().catch(() => ({}));
        const detail = payload.detail || payload || {};
        if (detail.new_url) showExpired(detail.new_url);
        throw new Error('payment_link_expired');
      }
      if (!res.ok) {
        const t = await res.text().catch(()=>'');
        console.error('create-order ERROR:', res.status, t);
        throw new Error(`create_order_failed_${res.status}`);
      }
      const data = await res.json();     
      return data.id;                   
    }

    async function captureOnBackend(orderID) {
      const res = await fetch(`${API_BASE}/paypal/capture`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
        body: JSON.stringify({ ...CTX, order_id: orderID }),
      });

      if (res.status === 410) {
        const payload = await res.json().catch(() => ({}));
        const detail = payload.detail || payload || {};
        if (detail.new_url) showExpired(detail.new_url);
        throw new Error('payment_link_expired');
      }
      if (!res.ok) {
        const t = await res.text().catch(()=>'');
        console.error('capture ERROR:', res.status, t);
        throw new Error(`capture_failed_${res.status}`);
      }
      return res.json();
    }

    function init() {
      if (!CTX.uid || !CTX.ts || !CTX.state) {
        show($('params-missing'));
        $('paypal').style.display = 'none';
        return;
      }

      if (!window.paypal || typeof paypal.Buttons !== 'function') {
        console.warn('PayPal SDK ещё не готов');
        return;
      }

      paypal.Buttons({
        style: { layout: 'vertical', shape: 'rect', color: 'gold', tagline: false },

        createOrder: async () => {
          return await createOrderOnBackend();
        },

        onApprove: async (data) => {
          await captureOnBackend(data.orderID);
          show($('ok-msg'));
          openBotChat();
        },

        onError: (err) => {
          console.error('PayPal onError:', err);
          alert('Ошибка при оплате. Попробуйте ещё раз или напишите нам.');
        }
      }).render('#paypal');
    }

    window.addEventListener('load', init);
  </script>
</body>
</html>
