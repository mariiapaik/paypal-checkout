<!doctype html>
<html lang="sk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Platba za kurz</title>
  <style>
    :root { --bg:#0b0c10; --card:#15171c; --text:#e9edf1; --muted:#98a2b3; --radius:16px; }
    *{box-sizing:border-box} html,body{height:100%}
    body{
      margin:0; background:radial-gradient(1200px 600px at 80% -10%, #1b1e27 0, #0b0c10 55%);
      color:var(--text); font:16px/1.5 ui-sans-serif,system-ui,-apple-system,Inter,Segoe UI,Roboto,Helvetica,Arial;
      display:grid; place-items:center; padding:24px;
    }
    .card{
      width:min(680px,92vw); background:linear-gradient(180deg,#171a20,#12141a);
      border:1px solid #242735; border-radius:var(--radius);
      box-shadow:0 10px 30px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.02);
      padding:clamp(20px,3.5vw,36px);
    }
    .head{display:flex; align-items:flex-start; justify-content:space-between; gap:12px;}
    h1{margin:0 0 6px; font-size:clamp(22px,3.2vw,28px)}
    .sub{margin:0 0 18px; color:var(--muted); font-size:14px}
    .price{display:inline-block; margin:10px 0 22px; padding:8px 12px; border:1px dashed #2b3042; border-radius:999px; color:#cbd5e1; font-weight:600}
    .divider{height:1px; background:#222532; margin:18px 0}
    .note{margin-top:18px; color:var(--muted); font-size:12px}
    .footer{margin-top:14px; display:flex; gap:10px; align-items:center; color:var(--muted); font-size:12px}
    .badge{color:#c7d2fe; background:#1d2140; border:1px solid #2a2f6c; padding:4px 8px; border-radius:999px}
    .warn{background:#2a1320;border:1px solid #53233f;color:#ffd0d8;padding:12px 14px;border-radius:12px;margin:12px 0}
    .ok{background:#112618;border:1px solid #1f5c34;color:#c9ffd9;padding:12px 14px;border-radius:12px;margin:12px 0}
    .hidden{display:none}
    a.btn{display:inline-block;padding:10px 14px;border:1px solid #2b3042;border-radius:10px;color:#e9edf1;text-decoration:none}

    .paybtn { width:100%; height:52px; margin:12px 0; }

    .label-badge{
      display:inline-flex; align-items:center; gap:8px;
      padding:6px 10px; border-radius:999px;
      background:linear-gradient(135deg,#1d2140 0%,#222b4d 60%,#1b2341 100%);
      border:1px solid #2a2f6c; color:#e6eaff; font-weight:600; white-space:nowrap;
      box-shadow:inset 0 0 0 1px rgba(255,255,255,.04);
    }
    .label-row{margin:0 0 8px; display:flex; justify-content:space-between; align-items:center; gap:10px}
    .label-muted{color:#98a2b3; font-size:12px}

    #applepay-container apple-pay-button.ap-btn{ display:block; width:100%; height:auto; border-radius:10px; }
  </style>

  <!-- Apple Pay SDK -->
  <script src="https://applepay.cdn-apple.com/jsapi/1.latest/apple-pay-sdk.js"></script>

  <!-- PayPal SDK (СТАТИЧЕСКИ, КАК В РАБОТАЮЩЕЙ ВЕРСИИ)
       ВАЖНО: client-id и currency ДОЛЖНЫ СОВПАДАТЬ с backend settings -->
  <script
    id="paypal-sdk"
    src="https://www.paypal.com/sdk/js?client-id=AU819ybHigRuHXuhwMIuMBk7ESAkJurInwOz3mDuW7-VpIGxkgHFpDd4bOLERLbvsOEVASNOyCGSqL8l&components=buttons,applepay&currency=EUR&intent=capture"
    data-sdk-integration-source="custom">
  </script>
</head>
<body>
  <main class="card">
    <div class="label-row">
      <div id="course-label" class="label-badge">—</div>
      <div class="label-muted" id="course-label-right"></div>
    </div>

    <div class="head">
      <div>
        <h1>Platba za kurz</h1>
        <p class="sub">Po úspešnej platbe dostanete prístup k lekciám v Telegram-bote.</p>
      </div>
    </div>

    <div class="price" id="price"></div>

    <div id="params-missing" class="warn hidden">
      Váš odkaz neobsahuje žiadne parametre. Otvorte stránku platby znovu z bota – kliknite na „Zaplatiť“.
    </div>
    <div id="expired" class="warn hidden">
      Odkaz na platbu vypršal. <a id="expired-link" class="btn" href="#">Získať nový odkaz</a>
    </div>
    <div id="ok-msg" class="ok hidden">
      Platba prebehla úspešne ✅ Skontrolujte správy v Telegram-bote — tam je odoslaná prvá lekcia.
    </div>

    <!-- Кнопки -->
    <div id="applepay-container" style="margin:12px 0"></div>
    <div id="paypal"></div>

    <div class="divider"></div>
    <p class="note">
      Podporované sú platby prostredníctvom Apple&nbsp;Pay, PayPal a bankových kariet.
      Ak sa platba nezačala alebo platnosť odkazu vypršala, vráťte sa do bota a kliknite na „Zaplatiť“ ešte raz.
    </p>

    <div class="footer">
      <span class="badge">Bezpečná platba</span><span>Spracovanie prostredníctvom PayPal</span>
    </div>
  </main>

  <script>
    const API_BASE = 'https://telegram-course-bot-lasico4qya-lm.a.run.app';
    const BOT = 'SDDSbecomingherCOURSE_bot';

    const $ = (id) => document.getElementById(id);
    const qs = new URLSearchParams(location.search);
    const CTX = {
      uid: Number(qs.get('uid') || '0'),
      ts: Number(qs.get('ts') || '0'),
      state: qs.get('state') || ''
    };

    function show(el, flag=true){ el.classList[flag ? 'remove' : 'add']('hidden'); }
    function openBotChat() {
      const web = `https://t.me/${BOT}`;
      const deep = `tg://resolve?domain=${BOT}`;
      location.href = deep; setTimeout(() => { location.href = web; }, 300);
    }
    function showExpired(newUrl) {
      const apple = $('applepay-container'); const pp = $('paypal');
      if (apple) apple.style.display = 'none';
      if (pp) pp.style.display = 'none';
      $('expired-link').href = newUrl; show($('expired'));
    }
    function currencySymbol(cur) {
      switch ((cur || '').toUpperCase()) {
        case 'EUR': return '€'; case 'USD': return '$'; case 'PLN': return 'zł';
        case 'GBP': return '£'; case 'CZK': return 'Kč'; case 'UAH': return '₴';
        default: return cur ? (cur + ' ') : '';
      }
    }

    // тянем client_id/currency/amount/label (для UI и Apple Pay)
    async function fetchPayConfig() {
      const url = new URL(`${API_BASE}/paypal/page-config`);
      url.searchParams.set('uid', String(CTX.uid));
      url.searchParams.set('ts', String(CTX.ts));
      url.searchParams.set('state', CTX.state);

      const res = await fetch(url, { headers: { 'Accept': 'application/json' } });
      if (res.status === 410) {
        const payload = await res.json().catch(() => ({}));
        const detail = payload.detail || payload || {};
        if (detail.new_url) showExpired(detail.new_url);
        throw new Error('payment_link_expired');
      }
      if (!res.ok) throw new Error('pay_config_failed_' + res.status);
      return res.json(); // { client_id, currency, amount, label }
    }

    // backend create/capture
    async function createOrderOnBackend() {
      const res = await fetch(`${API_BASE}/paypal/create-order`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
        body: JSON.stringify(CTX),
      });
      if (res.status === 410) {
        const payload = await res.json().catch(() => ({}));
        const detail = payload.detail || payload || {};
        if (detail.new_url) showExpired(detail.new_url);
        throw new Error('payment_link_expired');
      }
      if (!res.ok) {
        const t = await res.text().catch(()=> ''); console.error('create-order ERROR:', res.status, t);
        throw new Error(`create_order_failed_${res.status}`);
      }
      const data = await res.json(); return data.id;
    }

    async function captureOnBackend(orderID) {
      const res = await fetch(`${API_BASE}/paypal/capture`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
        body: JSON.stringify({ ...CTX, order_id: orderID }),
      });
      if (res.status === 410) {
        const payload = await res.json().catch(() => ({}));
        const detail = payload.detail || payload || {};
        if (detail.new_url) showExpired(detail.new_url);
        throw new Error('payment_link_expired');
      }
      if (!res.ok) {
        const t = await res.text().catch(()=> ''); console.error('capture ERROR:', res.status, t);
        throw new Error(`capture_failed_${res.status}`);
      }
      return res.json();
    }

    // ждём готовности SDK, даже если он ещё подгружается
    function waitForPayPal(maxMs = 5000, step = 100) {
      return new Promise((resolve, reject) => {
        const start = Date.now();
        (function tick(){
          if (window.paypal && typeof window.paypal.Buttons === 'function') return resolve();
          if (Date.now() - start > maxMs) return reject(new Error('paypal_sdk_not_ready'));
          setTimeout(tick, step);
        })();
      });
    }

    function initPayPalButtons() {
      if (!window.paypal || typeof paypal.Buttons !== 'function') {
        console.warn('PayPal SDK ešte nie je pripravený'); return;
      }
      paypal.Buttons({
        style: { layout: 'vertical', shape: 'rect', color: 'gold', tagline: false },
        createOrder: async () => await createOrderOnBackend(),
        onApprove: async (data) => {
          await captureOnBackend(data.orderID);
          show($('ok-msg')); openBotChat();
        },
        onError: (err) => {
          console.error('PayPal onError:', err);
          alert('Chyba pri platbe. Skúste to znovu alebo kontaktujte podporu.');
        }
      }).render('#paypal');
    }

    async function initApplePay(currency, amount, label) {
      try {
        if (!window.ApplePaySession || !ApplePaySession.canMakePayments()) return;
        if (!window.paypal || !paypal.Applepay) return;

        const applepay = paypal.Applepay();
        const cfg = await applepay.config();
        if (!cfg.isEligible) return;

        const apContainer = $('applepay-container');
        apContainer.innerHTML = `<apple-pay-button id="ap-btn" class="ap-btn paybtn" buttonstyle="black" type="buy" locale="sk-SK"></apple-pay-button>`;

        $('ap-btn').addEventListener('click', async () => {
          try {
            const orderId = await createOrderOnBackend();
            const paymentRequest = {
              countryCode: cfg.countryCode || "SK",
              currencyCode: (currency || "EUR").toUpperCase(),
              merchantCapabilities: cfg.merchantCapabilities || ["supports3DS"],
              supportedNetworks: cfg.supportedNetworks || ["visa","masterCard","maestro","amex"],
              requiredBillingContactFields: ["name", "email", "postalAddress"],
              total: { label: label || "BecomingHer", amount: String(amount), type: "final" }
            };
            const session = new ApplePaySession(3, paymentRequest);

            session.onvalidatemerchant = (event) => {
              applepay.validateMerchant({ validationUrl: event.validationURL, displayName: label || "BecomingHer" })
                .then((res) => session.completeMerchantValidation(res.merchantSession))
                .catch((err) => { console.error("validateMerchant error:", err); session.abort(); });
            };
            session.onpaymentauthorized = (event) => {
              applepay.confirmOrder({ orderId, token: event.payment.token, billingContact: event.payment.billingContact })
                .then(() => captureOnBackend(orderId))
                .then(() => { session.completePayment(ApplePaySession.STATUS_SUCCESS); show($('ok-msg')); openBotChat(); })
                .catch((err) => { console.error("confirm/capture error:", err); session.completePayment(ApplePaySession.STATUS_FAILURE); alert('Chyba pri Apple Pay platbe. Skúste to znovu.'); });
            };
            session.oncancel = () => {};
            session.begin();
          } catch (e) {
            console.error("Apple Pay flow failed:", e);
            alert('Apple Pay momentálne nie je dostupné.');
          }
        });
      } catch (e) { console.warn("Apple Pay init failed", e); }
    }

    async function init() {
      if (!CTX.uid || !CTX.ts || !CTX.state) {
        show($('params-missing'));
        const apple = $('applepay-container'); const pp = $('paypal');
        if (apple) apple.style.display = 'none';
        if (pp) pp.style.display = 'none';
        return;
      }

      try {
        const cfg = await fetchPayConfig(); // { client_id, currency, amount, label }
        const label = cfg.label || 'BecomingHer';

        // UI
        const sign = currencySymbol(cfg.currency);
        const price = $('price');
        if (price) {
          price.textContent = sign ? `${sign}${cfg.amount} • jednorazovo`
                                   : `${cfg.amount} ${cfg.currency} • jednorazovo`;
        }
        const lb = $('course-label'); if (lb) lb.textContent = label;
        const lr = $('course-label-right'); if (lr) lr.textContent = sign ? `${sign}${cfg.amount}` : `${cfg.amount} ${cfg.currency}`;
        document.title = `${label} — Platba`;

        // (необязательная проверка консистентности)
        const sdkSrc = document.getElementById('paypal-sdk')?.src || '';
        if (!sdkSrc.includes(encodeURIComponent(cfg.client_id))) {
          console.warn('[pay] client_id v SDK не совпадает с backend. Проверь settings.paypal_client_id и тег в <head>.');
        }
        if (!sdkSrc.includes(`currency=${encodeURIComponent(cfg.currency)}`)) {
          console.warn('[pay] currency v SDK не совпадает с backend. Проверь settings.currency и тег в <head>.');
        }

        // ждём SDK → рендерим кнопки → Apple Pay
        await waitForPayPal(7000, 100);
        initPayPalButtons();
        await initApplePay(cfg.currency, cfg.amount, label);

      } catch (e) {
        console.error('Init failed:', e);
        if (!String(e.message || '').includes('payment_link_expired')) {
          alert('Stránka platby sa nepodarila inicializovať. Skúste to znova.');
        }
      }
    }

    window.addEventListener('load', init);
  </script>
</body>
</html>
