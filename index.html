<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Оплата курса</title>
  <style>
    :root {
      --bg: #0b0c10; --card: #15171c; --text: #e9edf1; --muted: #98a2b3; --accent: #4f46e5; --radius: 16px;
    }
    *{box-sizing:border-box} html,body{height:100%}
    body{
      margin:0; background:radial-gradient(1200px 600px at 80% -10%, #1b1e27 0, #0b0c10 55%);
      color:var(--text); font:16px/1.5 ui-sans-serif,system-ui,-apple-system,"SF Pro Text",Inter,Segoe UI,Roboto,Helvetica,Arial;
      display:grid; place-items:center; padding:24px;
    }
    .card{
      width:min(680px,92vw); background:linear-gradient(180deg,#171a20,#12141a);
      border:1px solid #242735; border-radius:var(--radius);
      box-shadow:0 10px 30px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.02);
      padding:clamp(20px,3.5vw,36px);
    }
    h1{margin:0 0 6px; font-size:clamp(22px,3.2vw,28px); letter-spacing:.2px}
    .sub{margin:0 0 18px; color:var(--muted); font-size:14px}
    .price{display:inline-block; margin:10px 0 22px; padding:8px 12px; border:1px dashed #2b3042; border-radius:999px; color:#cbd5e1; font-weight:600}
    .group{margin-top:8px; display:grid; gap:12px}
    .divider{height:1px; background:#222532; margin:18px 0}
    .note{margin-top:18px; color:var(--muted); font-size:12px}
    .footer{margin-top:14px; display:flex; gap:10px; align-items:center; color:var(--muted); font-size:12px}
    .badge{color:#c7d2fe; background:#1d2140; border:1px solid #2a2f6c; padding:4px 8px; border-radius:999px}
    .hidden{display:none}
  </style>

  <!-- PayPal SDK: включаем нужные источники оплаты -->
  <script src="https://www.paypal.com/sdk/js?client-id=AUQBuv0K4YLfNtqKGZBbOIAux9z5VaqNO7fQ9ukPlV_fiJTpcM7Rf1IKKEMTz3N--9i-BWytMUS3tNIC&components=buttons&currency=EUR&intent=capture"></script>
</head>
<body>
  <main class="card">
    <h1>Оплата курса</h1>
    <p class="sub">После успешной оплаты доступ к урокам придёт в Telegram-бот.</p>
    <div class="price">€10.00 • единоразово</div>

    <div class="group">
      <!-- Контейнеры кнопок -->
      <div id="paypal"></div>
      <div id="applepay" class="hidden"></div>
      <div id="googlepay" class="hidden"></div>
      <div id="card" class="hidden"></div>
    </div>

    <div class="divider"></div>
    <p class="note">
      Поддерживаются PayPal и банковские карты. Apple Pay появляется только в Safari на устройствах, где он настроен.
    </p>

    <div class="footer">
      <span class="badge">Безопасный платёж</span><span>Обработка через PayPal</span>
    </div>
  </main>

  <script>
  // === Конфиг ===
  const API = 'https://telegram-course-bot-lasico4qya-lm.a.run.app';
  const qs = new URLSearchParams(location.search);
  const CTX = { uid: qs.get('uid'), ts: qs.get('ts'), state: qs.get('state') };

  // Общие функции для всех способов
  async function createOrder() {
    const res = await fetch(`${API}/payments/paypal/create`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(CTX),
    });
    if (!res.ok) throw new Error('Create order failed');
    const { id } = await res.json();
    return id;
  }

  async function onApprove(data) {
    const res = await fetch(`${API}/payments/paypal/capture?orderId=${data.orderID}`, { method: 'POST' });
    if (!res.ok) throw new Error('Capture failed');
    await res.json();
    alert('Оплата прошла ✅ Проверь Telegram-бота — доступ придёт туда.');
  }

  function onError(err) {
    console.error(err);
    alert('Ошибка при оплате. Попробуйте ещё раз или напишите нам.');
  }

  // Инициализация после загрузки SDK
  function initButtons() {
    if (!window.paypal || typeof paypal.Buttons !== 'function') {
      console.warn('PayPal SDK ещё не готов');
      return;
    }

    // «Умная» кнопка (PayPal + локальные методы типа P24)
    paypal.Buttons({
      style: { layout: 'vertical', shape: 'rect', color: 'gold', tagline: false },
      createOrder, onApprove, onError
    }).render('#paypal');

    // Вспомогательная функция для отдельных источников
    const tryRender = (fundingKey, elId, style = {}) => {
      if (!paypal.FUNDING || !paypal.FUNDING[fundingKey]) return;
      const btn = paypal.Buttons({
        fundingSource: paypal.FUNDING[fundingKey],
        style,                    // <— БЕЗ label!
        createOrder, onApprove, onError
      });
      if (btn.isEligible()) {
        document.getElementById(elId)?.classList.remove('hidden');
        btn.render('#' + elId);
      }
    };

    // Отдельные кнопки — только если реально доступны аккаунту/браузеру
    tryRender('CARD',      'card',      { color: 'black', shape: 'rect' }); // без label!
    tryRender('GOOGLEPAY', 'googlepay');                                   // без label!
    tryRender('APPLEPAY',  'applepay');                                    // без label!
  }

  if (document.readyState === 'complete') initButtons();
  else window.addEventListener('load', initButtons);
</script>

</body>
</html>
