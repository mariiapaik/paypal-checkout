<!doctype html>
<html lang="sk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Platba za kurz</title>
  <style>
    /* === Pink theme tokens === */
    :root{
      --bg0:#1b0f15;
      --bg1:#2a1521;
      --bg2:#311728;
      --card-top:#2d1825;
      --card-bot:#22121c;
      --text:#fff4fb;
      --muted:#c7a9b7;
      --accent:#ff4ea3;
      --accent-2:#ff8ac2;
      --ring:#5a1e40;
      --radius:18px;
      --safe-b: env(safe-area-inset-bottom, 0px);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      color:var(--text);
      font:16px/1.55 ui-sans-serif,system-ui,-apple-system,Inter,Segoe UI,Roboto,Helvetica,Arial;

      /* фон не «обрывается» на iOS */
      min-height:100svh;
      background-color:var(--bg0);
      background:
        radial-gradient(900px 600px at 85% -10%, rgba(255,78,163,.18), transparent 55%),
        radial-gradient(700px 500px at -10% 0%, rgba(255,138,194,.18), transparent 60%),
        linear-gradient(180deg,var(--bg1),var(--bg2) 33%, var(--bg0) 100%);
      background-repeat:no-repeat;

      display:grid; place-items:center;
      padding:28px 18px calc(28px + var(--safe-b));
    }

    .card{
      width:min(980px,94vw);
      margin:auto; /* всегда по центру */
      background:linear-gradient(180deg,var(--card-top) 0%, var(--card-bot) 100%);
      border:1px solid var(--ring);
      border-radius:var(--radius);
      box-shadow:0 20px 50px rgba(0,0,0,.45), inset 0 1px 0 rgba(255,255,255,.04);
      overflow:hidden;
    }

    /* макет: две колонки на десктопе, одна — на мобайле */
    .content{
      display:grid; gap:22px;
      grid-template-columns: 1.2fr .9fr;
      padding:clamp(18px,3.5vw,34px);
    }
    @media (max-width:860px){
      .content{
        grid-template-columns:1fr;
        justify-items:center;   /* центрируем внутренние блоки */
      }
      .content > section,
      .content > .hero{
        width:100%;
        max-width:560px;        /* комфортная ширина формы на мобайле */
      }
      .hero{ order:-1; }        /* картинка наверх */
    }

    .head{display:flex; align-items:center; justify-content:space-between; gap:12px}
    h1{margin:0 0 8px; font-size:clamp(22px,3.2vw,28px)}
    .sub{margin:0 0 18px; color:var(--muted); font-size:14px}

    /* курс-бейдж */
    .label-row{display:flex; justify-content:space-between; align-items:center; gap:12px; margin:0 0 12px}
    .label-badge{
      display:inline-flex; align-items:center; gap:8px;
      padding:6px 12px; border-radius:999px;
      color:#ffe9f6; font-weight:700; letter-spacing:.2px;
      background:linear-gradient(135deg, #3a1630 0%, #4a183b 60%, #3a1330 100%);
      border:1px solid rgba(255,78,163,.45);
      box-shadow:0 4px 18px rgba(255,78,163,.18), inset 0 0 0 1px rgba(255,255,255,.04);
      max-width:80%; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .label-right{ color:var(--muted); font-size:13px; white-space:nowrap }
    @media (max-width:420px){ .label-right{display:none} }

    .price{
      display:inline-block; margin:8px 0 22px; padding:10px 14px;
      border:1px dashed rgba(255,138,194,.55);
      border-radius:999px; color:#ffe9f6; font-weight:700; letter-spacing:.2px;
      background:linear-gradient(180deg,rgba(255,78,163,.08),rgba(255,78,163,.03));
    }

    .divider{height:1px; background:linear-gradient(90deg, transparent, rgba(255,138,194,.28), transparent); margin:18px 0}
    .note{margin-top:18px; color:var(--muted); font-size:12px}

    .footer{margin-top:14px; display:flex; gap:10px; align-items:center; color:var(--muted); font-size:12px}
    .badge{color:#ffd9ec; background:rgba(255,78,163,.14); border:1px solid rgba(255,78,163,.4); padding:4px 10px; border-radius:999px}

    .warn{background:rgba(255,78,163,.12); border:1px solid rgba(255,78,163,.45); color:#ffd6e8; padding:12px 14px; border-radius:12px; margin:12px 0}
    .ok{background:#132618; border:1px solid #1f5c34; color:#c9ffd9; padding:12px 14px; border-radius:12px; margin:12px 0}
    .hidden{display:none}
    a.btn{display:inline-block;padding:10px 14px;border:1px solid rgba(255,138,194,.5);border-radius:10px;color:#ffe9f6;text-decoration:none}

    /* кнопки */
    .paybtn { width:100%; height:52px; margin:12px 0; }
    #applepay-container apple-pay-button.ap-btn{ display:block; width:100%; height:auto; border-radius:12px; }

    /* hero — не режем картинку на узких экранах */
    .hero{
      border-radius: calc(var(--radius) - 6px);
      overflow:hidden;
      border:1px solid rgba(255,138,194,.35);
      box-shadow:0 8px 30px rgba(255,78,163,.15);
      background:radial-gradient(240px 180px at 80% 10%, rgba(255,78,163,.18), transparent 60%);
      min-height: 260px;                 /* десктопная высота */
      display:grid; place-items:center;
    }
    .hero img{
      width:100%; height:100%; display:block;
      object-fit:cover; object-position:center; /* десктоп — можно кропнуть */
      filter:saturate(105%);
    }
    @media (max-width:860px){
      .hero{ min-height:auto; }          /* снимаем принудительную высоту */
      .hero img{
        height:auto;                      /* показываем целиком */
        object-fit:contain;               /* без обрезки */
      }
    }

    .hint{font-size:12px; color:var(--muted); margin:8px auto 0; text-align:center}
  </style>

  <!-- Apple Pay SDK -->
  <script src="https://applepay.cdn-apple.com/jsapi/1.latest/apple-pay-sdk.js"></script>

  <!-- PayPal SDK (как в стабильной версии; client-id/currency должны совпадать с backend) -->
  <script
    id="paypal-sdk"
    src="https://www.paypal.com/sdk/js?client-id=AU819ybHigRuHXuhwMIuMBk7ESAkJurInwOz3mDuW7-VpIGxkgHFpDd4bOLERLbvsOEVASNOyCGSqL8l&components=buttons,applepay&currency=EUR&intent=capture"
    data-sdk-integration-source="custom">
  </script>
</head>
<body>
  <main class="card">
    <div class="content">
      <!-- Hero сверху на мобилках -->
      <aside class="hero">
        <img src="./assets/hero.jpeg" alt="Kurzy – vizuál" />
      </aside>

      <!-- Текст + кнопки -->
      <section>
        <div class="label-row">
          <div id="course-label" class="label-badge">—</div>
          <div class="label-right" id="course-label-right"></div>
        </div>

        <div class="head">
          <div>
            <h1>Platba za kurz</h1>
            <p class="sub">Po úspešnej platbe dostanete prístup k lekciám v Telegram-bote.</p>
          </div>
        </div>

        <div class="price" id="price">—</div>

        <div id="params-missing" class="warn hidden">
          Váš odkaz neobsahuje žiadne parametre. Otvorte stránku platby znovu z bota – kliknite na „Zaplatiť“.
        </div>
        <div id="expired" class="warn hidden">
          Odkaz na platbu vypršal. <a id="expired-link" class="btn" href="#">Získať nový odkaz</a>
        </div>
        <div id="ok-msg" class="ok hidden">
          Platba prebehla úspešne ✅ Skontrolujte správy v Telegram-bote — tam je odoslaná prvá lekcia.
        </div>

        <!-- Кнопки -->
        <div id="applepay-container" style="margin:12px 0"></div>
        <div id="paypal"></div>

        <div class="divider"></div>
        <p class="note">
          Podporované sú platby prostredníctvom Apple&nbsp;Pay, PayPal a bankových kariet.
          Ak sa platba nezačala alebo platnosť odkazu vypršala, vráťte sa do bota a kliknite na „Zaplatiť“ ešte raz.
        </p>

        <div class="footer">
          <span class="badge">Bezpečná platba</span><span>Spracovanie prostredníctvom PayPal</span>
        </div>
      </section>
    </div>
    <div class="hint">Toto je bezpečná stránka platby. Po zaplatení vás presmerujeme späť do Telegram bota.</div>
  </main>

  <script>
    const API_BASE = 'https://telegram-course-bot-lasico4qya-lm.a.run.app';
    const BOT = 'SDDSbecomingherCOURSE_bot';

    const $ = (id) => document.getElementById(id);
    const qs = new URLSearchParams(location.search);
    const CTX = {
      uid: Number(qs.get('uid') || '0'),
      ts: Number(qs.get('ts') || '0'),
      state: qs.get('state') || ''
    };

    function show(el, flag=true){ el.classList[flag ? 'remove' : 'add']('hidden'); }
    function openBotChat() {
      const web = `https://t.me/${BOT}`;
      const deep = `tg://resolve?domain=${BOT}`;
      location.href = deep; setTimeout(() => { location.href = web; }, 300);
    }
    function showExpired(newUrl) {
      const apple = $('applepay-container'); const pp = $('paypal');
      if (apple) apple.style.display = 'none';
      if (pp) pp.style.display = 'none';
      $('expired-link').href = newUrl; show($('expired'));
    }
    function currencySymbol(cur) {
      switch ((cur || '').toUpperCase()) {
        case 'EUR': return '€'; case 'USD': return '$'; case 'PLN': return 'zł';
        case 'GBP': return '£'; case 'CZK': return 'Kč'; case 'UAH': return '₴';
        default: return cur ? (cur + ' ') : '';
      }
    }

    async function fetchPayConfig() {
      const url = new URL(`${API_BASE}/paypal/page-config`);
      url.searchParams.set('uid', String(CTX.uid));
      url.searchParams.set('ts', String(CTX.ts));
      url.searchParams.set('state', CTX.state);

      const res = await fetch(url, { headers: { 'Accept': 'application/json' } });
      if (res.status === 410) {
        const payload = await res.json().catch(() => ({}));
        const detail = payload.detail || payload || {};
        if (detail.new_url) showExpired(detail.new_url);
        throw new Error('payment_link_expired');
      }
      if (!res.ok) throw new Error('pay_config_failed_' + res.status);
      return res.json(); // { client_id, currency, amount, label }
    }

    async function createOrderOnBackend() {
      const res = await fetch(`${API_BASE}/paypal/create-order`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
        body: JSON.stringify(CTX),
      });
      if (res.status === 410) {
        const payload = await res.json().catch(() => ({}));
        const detail = payload.detail || payload || {};
        if (detail.new_url) showExpired(detail.new_url);
        throw new Error('payment_link_expired');
      }
      if (!res.ok) {
        const t = await res.text().catch(()=> ''); console.error('create-order ERROR:', res.status, t);
        throw new Error(`create_order_failed_${res.status}`);
      }
      const data = await res.json(); return data.id;
    }

    async function captureOnBackend(orderID) {
      const res = await fetch(`${API_BASE}/paypal/capture`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
        body: JSON.stringify({ ...CTX, order_id: orderID }),
      });
      if (res.status === 410) {
        const payload = await res.json().catch(() => ({}));
        const detail = payload.detail || payload || {};
        if (detail.new_url) showExpired(detail.new_url);
        throw new Error('payment_link_expired');
      }
      if (!res.ok) {
        const t = await res.text().catch(()=> ''); console.error('capture ERROR:', res.status, t);
        throw new Error(`capture_failed_${res.status}`);
      }
      return res.json();
    }

    function waitForPayPal(maxMs = 7000, step = 120) {
      return new Promise((resolve, reject) => {
        const t0 = Date.now();
        (function loop(){
          if (window.paypal && typeof window.paypal.Buttons === 'function') return resolve();
          if (Date.now() - t0 > maxMs) return reject(new Error('paypal_sdk_not_ready'));
          setTimeout(loop, step);
        })();
      });
    }

    function initPayPalButtons() {
      if (!window.paypal || typeof paypal.Buttons !== 'function') {
        console.warn('PayPal SDK ešte nie je pripravený'); return;
      }
      paypal.Buttons({
        style: { layout: 'vertical', shape: 'rect', color: 'gold', tagline: false },
        createOrder: async () => await createOrderOnBackend(),
        onApprove: async (data) => {
          await captureOnBackend(data.orderID);
          show($('ok-msg')); openBotChat();
        },
        onError: (err) => {
          console.error('PayPal onError:', err);
          alert('Chyba pri platbe. Skúste to znovu alebo kontaktujte podporu.');
        }
      }).render('#paypal');
    }

    async function initApplePay(currency, amount, label) {
      try {
        if (!window.ApplePaySession || !ApplePaySession.canMakePayments()) return;
        if (!window.paypal || !paypal.Applepay) return;

        const applepay = paypal.Applepay();
        const cfg = await applepay.config();
        if (!cfg.isEligible) return;

        const apContainer = $('applepay-container');
        apContainer.innerHTML = `<apple-pay-button id="ap-btn" class="ap-btn paybtn" buttonstyle="black" type="buy" locale="sk-SK"></apple-pay-button>`;

        $('ap-btn').addEventListener('click', async () => {
          try {
            const orderId = await createOrderOnBackend();
            const paymentRequest = {
              countryCode: cfg.countryCode || "SK",
              currencyCode: (currency || "EUR").toUpperCase(),
              merchantCapabilities: cfg.merchantCapabilities || ["supports3DS"],
              supportedNetworks: cfg.supportedNetworks || ["visa","masterCard","maestro","amex"],
              requiredBillingContactFields: ["name", "email", "postalAddress"],
              total: { label: label || "BecomingHer", amount: String(amount), type: "final" }
            };
            const session = new ApplePaySession(3, paymentRequest);

            session.onvalidatemerchant = (event) => {
              applepay.validateMerchant({ validationUrl: event.validationURL, displayName: label || "BecomingHer" })
                .then((res) => session.completeMerchantValidation(res.merchantSession))
                .catch((err) => { console.error("validateMerchant error:", err); session.abort(); });
            };
            session.onpaymentauthorized = (event) => {
              applepay.confirmOrder({ orderId, token: event.payment.token, billingContact: event.payment.billingContact })
                .then(() => captureOnBackend(orderId))
                .then(() => { session.completePayment(ApplePaySession.STATUS_SUCCESS); show($('ok-msg')); openBotChat(); })
                .catch((err) => { console.error("confirm/capture error:", err); session.completePayment(ApplePaySession.STATUS_FAILURE); alert('Chyba pri Apple Pay platbe. Skúste to znovu.'); });
            };
            session.oncancel = () => {};
            session.begin();
          } catch (e) {
            console.error("Apple Pay flow failed:", e);
            alert('Apple Pay momentálne nie je dostupné.');
          }
        });
      } catch (e) { console.warn("Apple Pay init failed", e); }
    }

    async function init() {
      if (!CTX.uid || !CTX.ts || !CTX.state) {
        show($('params-missing'));
        const apple = $('applepay-container'); const pp = $('paypal');
        if (apple) apple.style.display = 'none';
        if (pp) pp.style.display = 'none';
        return;
      }

      try {
        const cfg = await fetchPayConfig(); // { client_id, currency, amount, label }
        const label = cfg.label || 'BecomingHer';

        const sign = currencySymbol(cfg.currency);
        const price = $('price');
        if (price) price.textContent = sign ? `${sign}${cfg.amount} • jednorazovo` : `${cfg.amount} ${cfg.currency} • jednorazovo`;
        const lb = $('course-label'); if (lb) lb.textContent = label;
        const lr = $('course-label-right'); if (lr) lr.textContent = sign ? `${sign}${cfg.amount}` : `${cfg.amount} ${cfg.currency}`;
        document.title = `${label} — Platba`;

        await waitForPayPal(7000, 120);
        initPayPalButtons();
        await initApplePay(cfg.currency, cfg.amount, label);

      } catch (e) {
        console.error('Init failed:', e);
        if (!String(e.message || '').includes('payment_link_expired')) {
          alert('Stránka platby sa nepodarila inicializovať. Skúste to znova.');
        }
      }
    }

    window.addEventListener('load', init);
  </script>
</body>
</html>
