<!doctype html>
<html lang="sk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Platba za kurz</title>
  <style>
    :root { --bg:#0b0c10; --card:#15171c; --text:#e9edf1; --muted:#98a2b3; --radius:16px; }
    *{box-sizing:border-box} html,body{height:100%}
    body{
      margin:0; background:radial-gradient(1200px 600px at 80% -10%, #1b1e27 0, #0b0c10 55%);
      color:var(--text); font:16px/1.5 ui-sans-serif,system-ui,-apple-system,Inter,Segoe UI,Roboto,Helvetica,Arial;
      display:grid; place-items:center; padding:24px;
    }
    .card{
      width:min(680px,92vw); background:linear-gradient(180deg,#171a20,#12141a);
      border:1px solid #242735; border-radius:var(--radius);
      box-shadow:0 10px 30px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.02);
      padding:clamp(20px,3.5vw,36px);
    }
    h1{margin:0 0 6px; font-size:clamp(22px,3.2vw,28px)}
    .sub{margin:0 0 18px; color:var(--muted); font-size:14px}
    .price{display:inline-block; margin:10px 0 22px; padding:8px 12px; border:1px dashed #2b3042; border-radius:999px; color:#cbd5e1; font-weight:600}
    .divider{height:1px; background:#222532; margin:18px 0}
    .note{margin-top:18px; color:var(--muted); font-size:12px}
    .footer{margin-top:14px; display:flex; gap:10px; align-items:center; color:var(--muted); font-size:12px}
    .badge{color:#c7d2fe; background:#1d2140; border:1px solid #2a2f6c; padding:4px 8px; border-radius:999px}
    .warn{background:#2a1320;border:1px solid #53233f;color:#ffd0d8;padding:12px 14px;border-radius:12px;margin:12px 0}
    .ok{background:#112618;border:1px solid #1f5c34;color:#c9ffd9;padding:12px 14px;border-radius:12px;margin:12px 0}
    .hidden{display:none}
    a.btn{display:inline-block;padding:10px 14px;border:1px solid #2b3042;border-radius:10px;color:#e9edf1;text-decoration:none}

    /* одинаковая высота кнопок */
    .paybtn{ width:100%; height:56px; margin:12px 0; }
    #applepay-container apple-pay-button.ap-btn{
      display:block; width:100%; height:56px; border-radius:12px;
    }
  </style>

  <!-- Apple Pay JS -->
  <script src="https://applepay.cdn-apple.com/jsapi/1.latest/apple-pay-sdk.js"></script>
  <!-- PayPal SDK: buttons + applepay -->
  <script src="https://www.paypal.com/sdk/js?client-id=AU819ybHigRuHXuhwMIuMBk7ESAkJurInwOz3mDuW7-VpIGxkgHFpDd4bOLERLbvsOEVASNOyCGSqL8l&components=buttons,applepay&currency=EUR&intent=capture&onload=paypalSdkReady"></script>
</head>
<body>
  <main class="card">
    <h1>Platba za kurz</h1>
    <p class="sub">Po úspešnej platbe dostanete prístup k lekciám v Telegram-bote.</p>
    <div class="price">€10.00 • jednorazovo</div>

    <div id="params-missing" class="warn hidden">
      Váš odkaz neobsahuje žiadne parametre. Otvorte stránku platby znovu z bota – kliknite na „Zaplatiť“.
    </div>
    <div id="expired" class="warn hidden">
      Odkaz na platbu vypršal. <a id="expired-link" class="btn" href="#">Získať nový odkaz</a>
    </div>
    <div id="ok-msg" class="ok hidden">
      Platba prebehla úspešne ✅ Skontrolujte správy v Telegram-bote — tam je odoslaná prvá lekcia.
    </div>

    <!-- Кнопки -->
    <div id="applepay-container" style="margin:12px 0"></div>
    <div id="paypal"></div>

    <div class="divider"></div>
    <p class="note">
      Podporované sú platby prostredníctvom Apple&nbsp;Pay, PayPal a bankových kariet. Ak sa platba nezačala alebo platnosť odkazu vypršala, vráťte sa do bota a kliknite na „Zaplatiť“ ešte raz.
    </p>

    <div class="footer">
      <span class="badge">Bezpečná platba</span><span>Spracovanie prostredníctvom PayPal</span>
    </div>
  </main>

  <div id="pay-warn" class="warn hidden">
    Platobný modul sa nenačítal. Skúste vypnúť blokovanie reklamy alebo obnoviť stránku.
  </div>

  <script>
    // ------- конфиг -------
    const API_BASE = 'https://telegram-course-bot-lasico4qya-lm.a.run.app';
    const BOT = 'SDDSbecomingherCOURSE_bot';
    const PRICE_EUR = '10.00'; // должно совпадать с бэком

    // ------- утилиты -------
    const $ = (id) => document.getElementById(id);
    const qs = new URLSearchParams(location.search);
    const CTX = { uid:Number(qs.get('uid')||'0'), ts:Number(qs.get('ts')||'0'), state:qs.get('state')||'' };

    function show(el, flag=true){ el.classList[flag ? 'remove' : 'add']('hidden'); }
    function openBotChat(){ const web=`https://t.me/${BOT}`, deep=`tg://resolve?domain=${BOT}`; location.href=deep; setTimeout(()=>{location.href=web;},300); }

    function showExpired(newUrl){
      ['applepay-container','paypal'].forEach(id => { const n=$(id); if(n) n.style.display='none'; });
      $('expired-link').href = newUrl; show($('expired'));
    }

    async function createOrderOnBackend(){
      const res = await fetch(`${API_BASE}/paypal/create-order`, {
        method:'POST', headers:{'Content-Type':'application/json','Accept':'application/json'}, body:JSON.stringify(CTX)
      });
      if(res.status===410){ const p=await res.json().catch(()=>({})); const d=p.detail||p||{}; if(d.new_url) showExpired(d.new_url); throw new Error('payment_link_expired'); }
      if(!res.ok){ console.error('create-order ERROR:', res.status, await res.text().catch(()=>'')); throw new Error(`create_order_failed_${res.status}`); }
      const data = await res.json(); return data.id;
    }

    async function captureOnBackend(orderID){
      const res = await fetch(`${API_BASE}/paypal/capture`, {
        method:'POST', headers:{'Content-Type':'application/json','Accept':'application/json'}, body:JSON.stringify({ ...CTX, order_id: orderID })
      });
      if(res.status===410){ const p=await res.json().catch(()=>({})); const d=p.detail||p||{}; if(d.new_url) showExpired(d.new_url); throw new Error('payment_link_expired'); }
      if(!res.ok){ console.error('capture ERROR:', res.status, await res.text().catch(()=>'')); throw new Error(`capture_failed_${res.status}`); }
      return res.json();
    }

    // ------- PayPal Buttons (PayPal + карты внутри потока) -------
    function renderPayPalButtons(){
      if (!window.paypal || typeof paypal.Buttons !== 'function') {
        console.warn('paypal.Buttons is not ready'); return;
      }
      paypal.Buttons({
        style: { layout:'vertical', shape:'rect', color:'gold', tagline:false, height:56 },
        createOrder: async () => await createOrderOnBackend(),
        onApprove:  async (data) => { await captureOnBackend(data.orderID); show($('ok-msg')); openBotChat(); },
        onError:    (err)  => { console.error('PayPal onError:', err); alert('Chyba pri platbe. Skúste to znovu.'); }
      }).render('#paypal');
    }

    // ------- Apple Pay через PayPal Applepay -------
    async function renderApplePay(){
      try{
        if (!window.ApplePaySession || !ApplePaySession.canMakePayments()) { console.log('ApplePaySession not available'); return; }
        if (!window.paypal || !paypal.Applepay) { console.log('paypal.Applepay not ready'); return; }

        const applepay = paypal.Applepay();
        const cfg = await applepay.config();               // { isEligible, ... }
        if (!cfg.isEligible) { console.log('Apple Pay not eligible'); return; }

        $('applepay-container').innerHTML =
          '<apple-pay-button id="ap-btn" class="ap-btn paybtn" buttonstyle="black" type="buy" locale="sk-SK"></apple-pay-button>';

        $('ap-btn').addEventListener('click', async ()=>{
          try{
            const orderId = await createOrderOnBackend();
            const paymentRequest = {
              countryCode: cfg.countryCode || 'SK',
              currencyCode: 'EUR',
              merchantCapabilities: cfg.merchantCapabilities || ['supports3DS'],
              supportedNetworks: cfg.supportedNetworks || ['visa','masterCard','maestro','amex'],
              requiredBillingContactFields: ['name','email','postalAddress'],
              total: { label:'BecomingHer', amount: PRICE_EUR, type:'final' }
            };
            const session = new ApplePaySession(3, paymentRequest);

            session.onvalidatemerchant = (e)=>{
              applepay.validateMerchant({ validationUrl:e.validationURL, displayName:'BecomingHer' })
                .then(res => session.completeMerchantValidation(res.merchantSession))
                .catch(err => { console.error('validateMerchant', err); session.abort(); });
            };

            session.onpaymentauthorized = (e)=>{
              applepay.confirmOrder({ orderId, token:e.payment.token, billingContact:e.payment.billingContact })
                .then(()=>captureOnBackend(orderId))
                .then(()=>{ session.completePayment(ApplePaySession.STATUS_SUCCESS); show($('ok-msg')); openBotChat(); })
                .catch(err=>{ console.error('confirm/capture', err); session.completePayment(ApplePaySession.STATUS_FAILURE); alert('Chyba pri Apple Pay platbe.'); });
            };

            session.oncancel = ()=>{};
            session.begin();
          }catch(e){ console.error('Apple Pay flow failed', e); alert('Apple Pay momentálne nie je dostupné.'); }
        });
      }catch(e){ console.warn('Apple Pay init failed', e); }
    }

    // ------- надёжный запуск после загрузки SDK -------
    function startAll(){
      if (!CTX.uid || !CTX.ts || !CTX.state) {
        show($('params-missing'));
        ['applepay-container','paypal'].forEach(id=>{ const n=$(id); if(n) n.style.display='none'; });
        return;
      }
      renderPayPalButtons();
      renderApplePay();
    }

    // если SDK уже успел загрузиться к onload — стартуем сразу,
    // иначе дожидаемся события load на самом <script>
    window.addEventListener('load', () => {
      const sdk = document.getElementById('paypal-sdk');
      if (window.paypal) {
        startAll();
      } else if (sdk) {
        sdk.addEventListener('load', startAll, { once:true });
        // safety net: если событие потеряется, попробуем через 1с
        setTimeout(() => { if (window.paypal) startAll(); }, 1000);
      } else {
        // на всякий случай fallback
        const check = setInterval(() => {
          if (window.paypal) { clearInterval(check); startAll(); }
        }, 100);
      }
    });

    function paypalSdkReady() {
      try {
        if (!CTX.uid || !CTX.ts || !CTX.state) {
          show($('params-missing'));
          ['applepay-container','paypal'].forEach(id=>{ const n=$(id); if(n) n.style.display='none'; });
          return;
        }
        if (!window.paypal) {
          show($('pay-warn'));
          return;
        }
        initPayPalButtons();
        initApplePay();
      } catch (e) {
        console.error('paypalSdkReady failed', e);
        show($('pay-warn'));
      }
    }

    setTimeout(() => {
      if (!window.paypal && !document.hidden) {
        show($('pay-warn'));
      }
    }, 3000);
  </script>
</body>
</html>

