<!doctype html>
<html lang="ru">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Оплата курса</title>

<div id="app">
  <h1>Оплата курса</h1>
  <div id="paypal-buttons"></div>
  <div id="msg" style="margin-top:12px;color:#888"></div>
</div>

<script src="https://www.paypal.com/sdk/js?client-id=AUQBuv0K4YLfNtqKGZBbOIAux9z5VaqNO7fQ9ukPlV_fiJTpcM7Rf1IKKEMTz3N--9i-BWytMUS3tNIC&currency=EUR&intent=capture&components=buttons&enable-funding=card,applepay,googlepay"></script>
<script>
  const qs = new URLSearchParams(location.search);
  const uid   = qs.get('uid');
  const ts    = qs.get('ts');
  const state = qs.get('state');
  const bot   = qs.get('bot'); 

  const API = 'https://telegram-course-bot-741371625759.europe-central2.run.app'; 

  const msg = (t,c)=>{ const el=document.getElementById('msg'); el.style.color=c||'#888'; el.textContent=t; };

  if (!uid || !ts || !state) msg('Откройте эту страницу из Telegram бота (нет uid/ts/state).', '#c33');

  paypal.Buttons({
    onInit: (d,a)=>{ if(!uid||!ts||!state) a.disable(); },
    createOrder: async ()=>{
      msg('Создаём заказ…');
      const r = await fetch(`${API}/payments/paypal/create`, {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ uid, ts, state })
      });
      const j = await r.json();
      if (!r.ok || !j.id) throw new Error(j.message || 'Create order failed');
      msg('Готово. Подтвердите оплату в виджете.');
      return j.id;
    },
    onApprove: async ({orderID})=>{
      msg('Подтверждаем оплату…');
      const r = await fetch(`${API}/payments/paypal/capture`, {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ orderID, uid, ts, state })
      });
      const j = await r.json();
      if (!r.ok) throw new Error(j.message || 'Capture failed');
      msg('✅ Оплата прошла! Вернитесь в Telegram — доступ отправлен.', '#0a0');
      if (bot) setTimeout(()=>location.href=`https://t.me/${bot}`, 1500);
    },
    onError: (e)=> msg(String(e), '#c33'),
    onCancel: ()=> msg('Оплата отменена.')
  }).render('#paypal-buttons');
</script>
